# V1.5 Stage Architecture Redesign Plan

## Overview
Complete redesign of the stage transition system to eliminate character bleeding and create a cleaner, more maintainable architecture.

## Current Problems (v1.4)
- **Character Bleeding**: Lars's context might influence Wiktoria's responses despite stage transitions
- **Code Duplication**: 3 separate tools + 3 API routes with similar logic
- **Maintenance Complexity**: Stage definitions scattered across multiple files
- **Limited Flexibility**: Linear progression only, no dynamic stage jumping

## Proposed Solution: Universal Stage System

### Core Concept
Replace multiple hardcoded stage tools with one universal `changeStage` tool that uses a centralized `stageMap` for complete prompt/voice/tool isolation.

## Architecture Changes

### 1. Replace Multiple Tools with Universal Tool

**Remove:**
- `transferToWiktoria`
- `requestLarsPerspective` 
- `returnToWiktoria`

**Replace with:**
```typescript
const changeStageTool: SelectedTool = {
  temporaryTool: {
    modelToolName: "changeStage",
    description: "Switches to the next stage (prompt, voice, tools).",
    dynamicParameters: [
      {
        name: "contextData",
        location: ParameterLocation.BODY,
        schema: {
          type: "object",
          properties: {
            userName: { type: "string" },
            topic: { type: "string" },
            wiktoriaOpinion: { type: "string" },
            larsPerspective: { type: "string" },
            userInsights: { type: "string" }
          },
          required: ["userName", "topic"]
        },
        required: true
      },
      {
        name: "nextStage",
        location: ParameterLocation.BODY,
        schema: {
          type: "string",
          enum: ["larsCollect", "wiktoriaDebate", "larsPerspective", "wiktoriaEngage"]
        },
        required: true
      }
    ],
    http: {
      baseUrlPattern: `${toolsBaseUrl}/api/changeStage`,
      httpMethod: "POST"
    }
  }
};
```

### 2. Centralized Stage Map

```typescript
export const stageMap = {
  larsCollect: {
    prompt: getLarsCollectorPrompt(),
    voice: LARS_VOICE,
    selectedTools: [changeStageTool]
  },
  wiktoriaDebate: {
    prompt: getWiktoriaOpinionPrompt(),
    voice: WIKTORIA_VOICE,
    selectedTools: [changeStageTool]
  },
  larsPerspective: {
    prompt: getLarsPerspectivePrompt(),
    voice: LARS_VOICE,
    selectedTools: [changeStageTool]
  },
  wiktoriaEngage: {
    prompt: getWiktoriaEngagerPrompt(),
    voice: WIKTORIA_VOICE,
    selectedTools: [changeStageTool]
  }
} as const;
```

### 3. Updated Initial Configuration

```typescript
export const larsWiktoriaEnhancedConfig: DemoConfig = {
  title: "Lars & Wiktoria Enhanced Flow",
  overview: "Welcome to Political Performance...",
  callConfig: {
    systemPrompt: stageMap.larsCollect.prompt,
    model: "fixie-ai/ultravox-70B",
    languageHint: "auto", // Keep v1.4 Polish transcription fix
    voice: stageMap.larsCollect.voice,
    temperature: 0.4,
    maxDuration: "600s",
    timeExceededMessage: "Political performance time limit reached...",
    selectedTools: stageMap.larsCollect.selectedTools
  }
};
```

### 4. Single Universal API Route

**New file:** `app/api/changeStage/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { stageMap } from "@/app/lars-wiktoria-enhanced-config";

export async function POST(req: NextRequest) {
  const { contextData, nextStage } = await req.json();
  console.log(`üîÑ Stage Transition: ‚Üí ${nextStage}`);
  console.log(`Context:`, contextData);
  
  const stage = (stageMap as any)[nextStage];

  if (!stage) {
    console.error(`‚ùå Unknown stage: ${nextStage}`);
    return NextResponse.json({ error: `Unknown stage: ${nextStage}` }, { status: 400 });
  }

  const responseBody = {
    systemPrompt: stage.prompt,
    voice: stage.voice,
    selectedTools: stage.selectedTools,
    toolResultText: getStageTransitionMessage(nextStage, contextData)
  };

  const response = NextResponse.json(responseBody);
  response.headers.set("X-Ultravox-Response-Type", "new-stage");
  
  return response;
}

function getStageTransitionMessage(stage: string, context: any): string {
  const { userName, topic } = context;
  
  switch (stage) {
    case "wiktoriaDebate":
      return `(Wiktoria joining conversation) Hello ${userName}! I'm ready to discuss ${topic} with you.`;
    case "larsPerspective":
      return `(Lars joining for perspective) I'm ready to share my thoughts on ${topic}.`;
    case "wiktoriaEngage":
      return `(Wiktoria returning with enhanced context) I'm ready to continue our discussion about ${topic} with insights from both Lars and myself.`;
    default:
      return `(Stage transition to ${stage})`;
  }
}
```

## Prompt Updates Required

### All prompts need tool call changes:

**Old:**
```typescript
"MUST call transferToWiktoria tool after giving brief topic perspective"
```

**New:**
```typescript
"MUST call changeStage tool with nextStage: 'wiktoriaDebate' after giving brief topic perspective"
```

### Specific Changes Needed:

1. **Lars Collector Prompt:**
   - Change tool call to: `changeStage(nextStage: "wiktoriaDebate")`

2. **Wiktoria Opinion Prompt:**
   - Change tool call to: `changeStage(nextStage: "larsPerspective")`

3. **Lars Perspective Prompt:**
   - Change tool call to: `changeStage(nextStage: "wiktoriaEngage")`

4. **Wiktoria Engager Prompt:**
   - For loops: `changeStage(nextStage: "larsPerspective")`
   - For ending: No tool call, just conclude

## Files to Delete
- `app/api/transferToWiktoria/route.ts`
- `app/api/requestLarsPerspective/route.ts`
- `app/api/returnToWiktoria/route.ts`

## Benefits of New Architecture

### 1. **Complete Character Isolation**
Each stage transition creates a fresh LLM interpretive frame with zero character bleeding.

### 2. **Simplified Maintenance**
- Single API route to maintain
- All stage definitions in one place
- Consistent error handling

### 3. **Enhanced Flexibility**
- Can jump to any stage (not just linear)
- Easy to add new stages
- Dynamic stage progression possible

### 4. **Better Debugging**
- Centralized logging
- Clear stage transition tracking
- Unified error handling

### 5. **Future-Proof**
- Easy to add features like "restart conversation"
- Supports complex stage flows
- Scales for additional characters

## Implementation Plan

### Phase 1: Core Infrastructure
1. Create `changeStageTool` definition
2. Build `stageMap` with all stages
3. Create `/api/changeStage/route.ts`
4. Update main config to use `stageMap.larsCollect`

### Phase 2: Prompt Updates
1. Update Lars Collector prompt (changeStage calls)
2. Update Wiktoria Opinion prompt
3. Update Lars Perspective prompt  
4. Update Wiktoria Engager prompt

### Phase 3: Testing & Cleanup
1. Test all stage transitions
2. Verify context data passing
3. Confirm character isolation
4. Delete old API routes
5. Remove old tool definitions

### Phase 4: Validation
1. Full conversation flow testing
2. Polish transcription verification
3. Agent label accuracy testing
4. Ending logic confirmation

## Risk Mitigation

### Backup Strategy
- Keep v1.4-test as working fallback
- Implement v1.5 in new branch
- Thorough testing before merge

### Testing Checklist
- [ ] All 4 stages transition correctly
- [ ] Context data preserved across transitions
- [ ] Character voices switch properly
- [ ] No character bleeding observed
- [ ] Ending logic works
- [ ] Polish transcription maintained
- [ ] Agent labels correct

## Timeline Estimate
- **Day 1**: Core infrastructure implementation
- **Day 2**: Prompt updates and testing
- **Day 3**: Full system validation and deployment

## Success Criteria
1. Zero character bleeding between Lars and Wiktoria
2. Clean stage transitions with proper context passing
3. Simplified codebase with single API route
4. All v1.4-test functionality preserved
5. Enhanced flexibility for future features

---
**Proposed by**: Friend's architectural analysis  
**Planned for**: v1.5 (post v1.4-test)  
**Priority**: High (architectural improvement)  
**Breaking Change**: Yes (requires full prompt updates)